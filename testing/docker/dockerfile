FROM debian:latest

# Install dependencies
RUN apt-get update && apt-get upgrade -y && \
    apt-get install -y \
      git \
      build-essential \
      autoconf \
      automake \
      libtool \
      libssl-dev \
      pkg-config
    #   net-tools \
    #   nano

# Clone Siege into /opt/siege
RUN git clone https://github.com/JoeDog/siege.git /opt/siege
# RUN git clone https://github.com/RJW-db/siege.git /opt/siege
COPY siege/http.c /opt/siege/src/http.c

ARG WEBSERV_HOST_IP
ENV WEBSERV_HOST_IP=${WEBSERV_HOST_IP}
RUN mkdir -p /opt/postRequest && \
    echo "http://${WEBSERV_HOST_IP}:8080/upload POST < body.txt" > /opt/postRequest/urls.txt && \
    echo "http://${WEBSERV_HOST_IP}:8080/upload POST < body8MB.txt" > /opt/postRequest/urls8MB.txt && \
    printf -- '--boundary123\r\nContent-Disposition: form-data; name="myfile"; filename="test.txt"\r\nContent-Type: text/plain\r\n\r\nhello from siege!\r\n--boundary123--\r\n' > /opt/postRequest/body.txt && \
    printf -- '--boundary123\r\nContent-Disposition: form-data; name="myfile"; filename="test.txt"\r\nContent-Type: text/plain\r\n\r\n' > /opt/postRequest/body8MB.txt && \
    yes "hello from siege!" | head -c 8388608 >> /opt/postRequest/body8MB.txt && \
    printf -- '\r\n--boundary123--\r\n' >> /opt/postRequest/body8MB.txt
# Set working directory to /opt/siege
WORKDIR /opt/siege

# Build and install Siege
RUN chmod +x ./utils/bootstrap && \
    ./utils/bootstrap && \
    ./configure && \
    make -j && \
    make install

# GET and POST
RUN echo '#!/bin/sh\nsiege -c1 -t1s http://$WEBSERV_HOST_IP:8080/' > /usr/local/bin/get && \
    chmod +x /usr/local/bin/get && \
    echo '#!/bin/sh\nsiege -c2 -t10s --content-type "multipart/form-data; boundary=boundary123" --file=/opt/postRequest/urls.txt' > /usr/local/bin/post && \
    chmod +x /usr/local/bin/post && \
    echo '#!/bin/sh\nsiege -c40 -t10s --content-type "multipart/form-data; boundary=boundary123" --file=/opt/postRequest/urls8MB.txt' > /usr/local/bin/post2 && \
    chmod +x /usr/local/bin/post2

WORKDIR /opt/postRequest